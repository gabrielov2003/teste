{
    "cms_rendner_sdfv": {
        "polars": {
            "create_fingerprint": "from hashlib import blake2b\nfrom typing import Any\n\nfrom polars import DataFrame\n\n\ndef create_fingerprint(frame: DataFrame, org_data_source: Any = None) -> str:\n    fingerprint_input = [\n        id(org_data_source if org_data_source is not None else frame),\n        frame.shape,\n        frame.columns[:60],\n        frame.dtypes[:60]\n    ]\n    return blake2b('-'.join(str(x) for x in fingerprint_input).encode(), digest_size=16).hexdigest()\n",
            "frame_context": "from typing import List, Optional\n\nfrom polars import DataFrame\n\nfrom cms_rendner_sdfv.base.table_source import AbstractTableFrameGenerator, AbstractTableSourceContext\nfrom cms_rendner_sdfv.base.types import SortCriteria, TableStructure\nfrom cms_rendner_sdfv.polars.visible_frame import VisibleFrame\n\n\nclass FrameContext(AbstractTableSourceContext):\n    def __init__(self, source_frame: DataFrame):\n        self._source_frame = source_frame\n        self._sort_criteria: SortCriteria = SortCriteria()\n        self._visible_frame: VisibleFrame = self._recompute_visible_frame()\n\n    @property\n    def visible_frame(self) -> VisibleFrame:\n        return self._visible_frame\n\n    def set_sort_criteria(self, sort_by_column_index: Optional[List[int]], sort_ascending: Optional[List[bool]]):\n        new_sort_criteria = SortCriteria(sort_by_column_index, sort_ascending)\n        if new_sort_criteria != self._sort_criteria:\n            self._sort_criteria = new_sort_criteria\n            self._visible_frame = self._recompute_visible_frame()\n\n    def get_table_structure(self, fingerprint: str) -> TableStructure:\n        rows_count, columns_count = self._visible_frame.region.frame_shape\n        org_rows_count, org_cols_count = self._source_frame.shape\n        if rows_count == 0 or columns_count == 0:\n            rows_count = columns_count = 0\n        return TableStructure(\n            org_rows_count=org_rows_count,\n            org_columns_count=org_cols_count,\n            rows_count=rows_count,\n            columns_count=columns_count,\n            fingerprint=fingerprint,\n        )\n\n    def get_table_frame_generator(self) -> AbstractTableFrameGenerator:\n        from cms_rendner_sdfv.polars.table_frame_generator import TableFrameGenerator\n        return TableFrameGenerator(self._visible_frame)\n\n    def _recompute_visible_frame(self) -> VisibleFrame:\n        row_idx = None\n        if not self._sort_criteria.is_empty():\n            col_names = self._source_frame.columns\n\n            row_idx_col_name: str = \"cms_render_sdfv__row_nr\"\n            frame_with_index = self._source_frame.with_row_count(row_idx_col_name)\n\n            by_names = [col_names[i] for i in self._sort_criteria.by_column]\n            row_idx = frame_with_index \\\n                .sort(by_names, descending=[not asc for asc in self._sort_criteria.ascending]) \\\n                .get_column(row_idx_col_name)\n\n        return VisibleFrame(self._source_frame, row_idx)\n",
            "table_frame_generator": "import os\nfrom typing import List\n\nimport polars as pl\n\nfrom cms_rendner_sdfv.base.table_source import AbstractTableFrameGenerator\nfrom cms_rendner_sdfv.base.types import Region, TableFrame, TableFrameCell, TableFrameColumn\nfrom cms_rendner_sdfv.polars.visible_frame import VisibleFrame\n\n\nclass TableFrameGenerator(AbstractTableFrameGenerator):\n    def __init__(self, visible_frame: VisibleFrame):\n        super().__init__(visible_frame)\n\n    def generate(self,\n                 region: Region = None,\n                 exclude_row_header: bool = False,\n                 exclude_col_header: bool = False,\n                 ) -> TableFrame:\n        frame = self._visible_frame\n\n        if region is None:\n            region = frame.region\n        else:\n            region = frame.region.get_bounded_region(region)\n\n        column_labels = [] if exclude_col_header else self._extract_column_header_labels(frame, region)\n        cell_values = self._extract_cell_values(frame, region)\n\n        return TableFrame(\n            index_labels=None,\n            column_labels=column_labels,\n            legend=None,\n            cells=cell_values,\n        )\n\n    @staticmethod\n    def _extract_column_header_labels(frame: VisibleFrame, region: Region) -> List[TableFrameColumn]:\n        col_names = frame.source_frame.columns\n        dtypes = frame.source_frame.dtypes\n        return [TableFrameColumn(dtype=str(dtypes[i]), labels=[col_names[i]]) for i in frame.get_col_idx_in_source(region)]\n\n    @staticmethod\n    def _extract_cell_values(frame: VisibleFrame, region: Region) -> List[List[TableFrameCell]]:\n        result: List[List[TableFrameCell]] = []\n\n        if frame.region.is_empty():\n            return result\n\n        source_frame = frame.source_frame\n        dtypes = source_frame.dtypes\n        src_col_idx = frame.get_col_idx_in_source(region)\n        src_row_idx = frame.get_row_idx_in_source(region)\n\n        str_lengths = int(os.environ.get(\"POLARS_FMT_STR_LEN\", \"42\"))\n\n        for sci in src_col_idx:\n            series = source_frame.get_column(source_frame.columns[sci])\n            is_string = dtypes[sci] is pl.Utf8\n            should_create_row = not result\n            for ri, sri in enumerate(src_row_idx):\n                if is_string:\n                    v = series._s.get_fmt(sri, str_lengths + 2)\n                    if v[-1] == '\"':\n                        v = v[1:-1]\n                    else:\n                        v = v[1:-2] + v[-1]\n                else:\n                    v = series._s.get_fmt(sri, str_lengths)\n\n                if should_create_row:\n                    result.append([TableFrameCell(v)])\n                else:\n                    result[ri].append(TableFrameCell(v))\n\n        return result\n",
            "table_source": "from cms_rendner_sdfv.base.table_source import AbstractTableSource\nfrom cms_rendner_sdfv.base.types import TableSourceKind\nfrom cms_rendner_sdfv.polars.frame_context import FrameContext\n\n\nclass TableSource(AbstractTableSource):\n    def __init__(self, context: FrameContext, fingerprint: str):\n        super().__init__(TableSourceKind.TABLE_SOURCE, context, fingerprint)\n",
            "table_source_factory": "from typing import Any, Union\n\nimport polars as pl\n\nfrom cms_rendner_sdfv.base.table_source import AbstractTableSource, AbstractTableSourceFactory\nfrom cms_rendner_sdfv.base.types import CreateTableSourceConfig, CreateTableSourceFailure\nfrom cms_rendner_sdfv.polars.create_fingerprint import create_fingerprint\nfrom cms_rendner_sdfv.polars.frame_context import FrameContext\nfrom cms_rendner_sdfv.polars.table_source import TableSource\n\n\nclass TableSourceFactory(AbstractTableSourceFactory):\n\n    def _create_internal(self,\n                         data_source: Any,\n                         config: CreateTableSourceConfig,\n                         caller_globals: dict,\n                         ) -> Union[AbstractTableSource, CreateTableSourceFailure]:\n        ds_frame = None\n        if isinstance(data_source, dict):\n            ds_frame = pl.from_dict(data_source)\n        elif isinstance(data_source, pl.DataFrame):\n            ds_frame = data_source\n        else:\n            return CreateTableSourceFailure(error_kind=\"UNSUPPORTED_DATA_SOURCE_TYPE\", info=str(type(data_source)))\n\n        pre_fingerprint = config.previous_fingerprint\n        cur_fingerprint = create_fingerprint(ds_frame, data_source)\n        if pre_fingerprint is not None and pre_fingerprint != cur_fingerprint:\n            return CreateTableSourceFailure(error_kind=\"INVALID_FINGERPRINT\", info=cur_fingerprint)\n\n        return TableSource(FrameContext(ds_frame), fingerprint=cur_fingerprint)\n",
            "visible_frame": "from typing import List, Union\n\nimport polars as pl\n\nfrom cms_rendner_sdfv.base.table_source import AbstractVisibleFrame\nfrom cms_rendner_sdfv.base.types import Region\n\n\nclass VisibleFrame(AbstractVisibleFrame):\n    def __init__(self, source_frame: pl.DataFrame, row_idx: Union[None, pl.Series]):\n        self.source_frame = source_frame\n        self._row_idx = row_idx\n        self._region = Region.with_frame_shape(source_frame.shape)\n\n    @property\n    def region(self) -> Region:\n        return self._region\n\n    def get_row_idx_in_source(self, region: Region) -> List[int]:\n        r = range(region.first_row, region.first_row + region.rows)\n        if self._row_idx is None:\n            return list(r)\n        return [self._row_idx[i] for i in r]\n\n    def get_col_idx_in_source(self, region: Region) -> List[int]:\n        return list(range(region.first_col, region.first_col + region.cols))\n"
        }
    }
}